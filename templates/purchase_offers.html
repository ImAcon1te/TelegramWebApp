{% extends 'base.html' %}
{% block title %}Заявки на закупку{% endblock %}
{% block content %}
  <h1>Заявки на закупку</h1>
  <div style="margin-bottom: 20px;">
    <a href="{{ url_for('my_offers') }}">Мої пропозиції</a>
  </div>
  <div style="margin-bottom: 20px;">
    <a href="{{ url_for('create_offer') }}">Створити заявку</a>
    <!-- Кнопка для изменения ролей -->
    <button id="openRolesModal">ролі</button>
  </div>

  <!-- Навигация между типами заявок -->
  {% if user.is_sale %}
    <div style="margin-bottom: 20px;">
      <a href="{{ url_for('sale_offers') }}">Заявки на продажу</a>
    </div>
  {% endif %}
  {% if user.is_rental %}
    <div style="margin-bottom: 20px;">
      <a href="{{ url_for('rental_offers') }}">Заявки аренду</a>
    </div>
  {% endif %}
  <div style="margin-bottom: 20px;">
    <a href="{{ url_for('incoming_notifications') }}">Оповещения</a>
  </div>

  {% for offer in purchase_offers %}
    <div class="offer-block" style="border: 1px solid #ccc; padding: 15px; margin-bottom: 15px;">
      <h2>Заявка на закупку №{{ offer.id }}</h2>
      <p><strong>Пользователь (User ID):</strong> {{ offer.user_id }}</p>
      <p><strong>Тип культуры/товара:</strong> {{ offer.commodity_type }}</p>
      <p><strong>Тоннаж:</strong> {{ offer.tonnage }}</p>
      <p><strong>Цена за тонну:</strong> {{ offer.price_per_ton }}</p>
      <p><strong>Тип закупщика:</strong> {{ offer.buyer_type }}</p>
      <p>
        <strong>Регион:</strong> {{ offer.region.oblast }}{% if offer.region.district %} - {{ offer.region.district }}{% endif %}
      </p>
      <p><strong>Дополнительно:</strong> {{ offer.additional_info or '—' }}</p>
      <p><small>Создано: {{ offer.created_at.strftime("%d.%m.%Y %H:%M") }}</small></p>
      <p><small>Обновлено: {{ offer.updated_at.strftime("%d.%m.%Y %H:%M") }}</small></p>
      <button class="create-notification-btn" data-offer-id="{{ offer.id }}" data-offer-type="purchase">+</button>
    </div>
  {% else %}
    <p>Нет заявок на закупку</p>
  {% endfor %}

  <!-- Модальное окно для создания уведомления (закупка: comment, overwrite_sum и overwrite_amount) -->
  <div id="notificationModal" class="modal-overlay">
    <div class="modal-content">
      <span id="modalClose" class="modal-close">&times;</span>
      <h2>Создать предложение</h2>
      <form id="notificationForm">
        <div class="form-group">
          <label for="comment">Комментарий:</label>
          <textarea id="comment" name="comment" rows="3"></textarea>
        </div>
        <div class="form-group">
          <label for="overwrite_sum">Новая цена (опционально):</label>
          <input type="number" step="0.01" id="overwrite_sum" name="overwrite_sum">
        </div>
        <div class="form-group">
          <label for="overwrite_amount">Новое количество (опционально):</label>
          <input type="number" step="0.01" id="overwrite_amount" name="overwrite_amount">
        </div>
        <!-- Скрытые поля -->
        <input type="hidden" id="offer_id" name="offer_id">
        <input type="hidden" id="offer_type" name="offer_type">
      </form>
      <div class="modal-buttons">
        <button id="cancelModal">Отмена</button>
        <button id="saveNotification">Сохранить</button>
      </div>
    </div>
  </div>
  <!-- Модальное окно для изменения ролей -->
   <div id="rolesModal" class="modal-overlay">
      <div class="modal-content">
        <span id="closeRolesModal" class="modal-close">&times;</span>
        <h2>Изменить роли</h2>
        <form id="rolesForm">
          <div class="form-group">
            <input type="checkbox" id="is_sale" name="is_sale" {% if user.is_sale %}checked{% endif %}>
            <label for="is_sale">Продажа</label>
          </div>
          <div class="form-group">
            <input type="checkbox" id="is_purchase" name="is_purchase" {% if user.is_purchase %}checked{% endif %}>
            <label for="is_purchase">Покупка</label>
          </div>
          <div class="form-group">
            <input type="checkbox" id="is_rental" name="is_rental" {% if user.is_rental %}checked{% endif %}>
            <label for="is_rental">Аренда</label>
          </div>
        </form>
        <div class="modal-buttons">
          <button id="cancelRolesModal">Отмена</button>
          <button id="saveRoles">Сохранить</button>
        </div>
      </div>
    </div>
  <style>
    /* Стили модального окна */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.5);
      z-index: 1000;
    }
    .modal-content {
      position: relative;
      width: 400px;
      margin: 100px auto;
      background: #fff;
      padding: 20px;
      border-radius: 4px;
    }
    .modal-close {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 20px;
      cursor: pointer;
    }
    .modal-buttons {
      text-align: right;
      margin-top: 15px;
    }
    .modal-buttons button {
      margin-left: 10px;
    }
  </style>

  <script src="{{ url_for('static', filename='purchase_offers.js') }}"></script>
  <script src="{{ url_for('static', filename='update_roles.js') }}"></script>
{% endblock %}
